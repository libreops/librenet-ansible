---
- hosts: all
  sudo: yes
  gather_facts: false
  sudo_user: root

  tasks:
    - name: Make sure needed directories exist
      file: path={{ item }} state=directory recurse=yes
      with_items:
        - /root/bin
        - /var/backup/latest
      register: bin_path

    - name: Copy backup script
      copy: >
        src=../scripts/backup.sh
        dest=/root/bin/backup.sh
        owner=root
        group=root
        mode=700
      when: bin_path|success

    - name: Run backup script
      shell: >
        chdir=/root/bin/
        bash backup.sh
